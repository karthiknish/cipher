rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    // Uses email check as primary method since custom claims can be delayed
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'karthik.nishanth06@gmail.com' ||
        request.auth.token.role == 'admin'
      );
    }
    
    // Users collection - for auth roles
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // User profiles collection
    match /userProfiles/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // Products collection - public read, admin write
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Blogs collection - public read, admin write
    match /blogs/{blogId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Allow list/get for admins without resource check
      allow list: if isAdmin();
      // Users can read their own orders, admins can read all
      allow get: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      // Users can create orders for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Only admins can update orders (status changes)
      allow update: if isAdmin();
      // Only admins can delete orders
      allow delete: if isAdmin();
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Users can update their own reviews, admins can update any (for moderation, replies)
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
    }
    
    // Review votes collection - tracks user votes on reviews
    match /reviewVotes/{voteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
    
    // Wishlists collection
    match /wishlists/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Carts collection
    match /carts/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Stock notifications collection
    match /stockNotifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow update: if isAdmin();
    }
    
    // Promo codes collection - public read for validation, admin write
    match /promoCodes/{codeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Analytics/metrics collection - authenticated write for tracking, admin read
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow write: if true;  // Allow anonymous analytics tracking
      
      // Nested collections for analytics events
      match /{collection}/{eventId} {
        allow read: if isAdmin();
        allow write: if true;  // Allow anonymous event tracking
      }
    }
    
    // Inventory collection - public read, admin write
    match /inventory/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Stock movements collection - admin only
    match /stockMovements/{movementId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Bundles collection - public read, admin write
    match /bundles/{bundleId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Chat/support messages
    match /chatMessages/{messageId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // Live activities collection - public read, authenticated write
    match /liveActivities/{activityId} {
      allow read: if true;
      allow create: if true;  // Allow anonymous activity tracking
      allow update, delete: if isAdmin();
    }
    
    // Product viewers collection - public read/write for real-time tracking
    match /productViewers/{productId} {
      allow read: if true;
      allow write: if true;  // Allow anonymous view tracking
      
      // Nested viewers subcollection
      match /viewers/{viewerId} {
        allow read: if true;
        allow write: if true;  // Allow anonymous view tracking
      }
    }
    
    // Dynamic pricing rules collection - public read, admin write
    match /pricingRules/{ruleId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Design contests/voting collection - public read, admin write
    match /designContests/{contestId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Design votes collection - authenticated users can vote
    match /designVotes/{voteId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Abandoned carts collection - public read for tracking, admin manage
    match /abandonedCarts/{cartId} {
      allow read: if true;
      allow create: if true;  // Allow cart tracking
      allow update, delete: if isAdmin();
    }
    
    // Influencers collection - public read, admin write
    match /influencers/{influencerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Influencer sales collection - admin only
    match /influencerSales/{saleId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Influencer applications - authenticated create, admin manage
    match /influencerApplications/{applicationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow list: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Loyalty profiles collection - user owns their profile, admin can read all
    match /loyalty/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
      allow list: if isAdmin();
    }
    
    // Rewards collection - for tracking redeemed reward codes
    match /rewards/{rewardCode} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // User achievements collection - user owns their achievements, admin can read all
    match /userAchievements/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
      allow list: if isAdmin();
    }
    
    // Customer behavior analytics collection
    match /customerBehavior/{docId} {
      allow read: if isAdmin();
      allow write: if true;  // Allow anonymous behavior tracking
      
      // Users subcollection under profiles
      match /users/{userId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if true;  // Allow anonymous tracking
        allow list: if isAdmin();
      }
    }
    
    // Customer behavior profiles - direct access
    match /customerBehavior/profiles/users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if true;  // Allow anonymous tracking
      allow list: if isAdmin();
    }
    
    // Customer behavior sessions
    match /customerBehavior/sessions/{status}/{sessionId} {
      allow read: if isAdmin();
      allow write: if true;  // Allow anonymous session tracking
    }
    
    // Customer behavior analytics events
    match /customerBehavior/analytics/{eventType}/{eventId} {
      allow read: if isAdmin();
      allow write: if true;  // Allow anonymous analytics tracking
    }
    
    // Spin wheel results collection - users can read/write their own results
    match /spinWheelResults/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isAdmin();
      allow list: if isAdmin();
    }
    
    // User measurements collection - for size recommendations
    match /userMeasurements/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // Influencer clicks collection - for tracking referral clicks
    match /influencerClicks/{clickId} {
      allow read: if isAdmin();
      allow create: if true;  // Allow anonymous click tracking
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================================================
    // LOCAL SCENE COLLECTIONS (Events, Stores)
    // ==========================================================================
    
    // Events collection - public read, admin write
    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Event RSVPs subcollection - authenticated users can RSVP
    match /events/{eventId}/rsvps/{rsvpId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid || isAdmin();
    }
    
    // Event RSVPs as top-level collection (legacy underscore path)
    match /event_rsvps/{rsvpId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow list: if isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
    }

    // Event RSVPs as top-level collection (camelCase path used by app)
    match /eventRSVPs/{rsvpId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow list: if isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
    }
    
    // Stores collection - public read, admin write
    match /stores/{storeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ==========================================================================
    // NEWSLETTER COLLECTION
    // ==========================================================================
    
    // Newsletter subscribers - public subscribe, admin manage
    match /newsletter_subscribers/{subscriberId} {
      // Anyone can check if an email exists (for duplicate check)
      allow read: if isAdmin();
      // Anyone can subscribe (public form)
      allow create: if true;
      // Only admin can update (tags, status changes)
      allow update: if isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Newsletter campaigns - admin only
    match /newsletter_campaigns/{campaignId} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
    
    // ==========================================================================
    // GAMIFICATION COLLECTIONS (Challenges, Achievements)
    // ==========================================================================
    
    // Style challenges collection - public read, admin write
    match /style_challenges/{challengeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Challenge submissions - authenticated users can submit
    match /challenge_submissions/{submissionId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Achievement definitions - public read, admin write
    match /achievement_definitions/{achievementId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
